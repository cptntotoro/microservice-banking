<section th:fragment="content" class="dashboard-layout">
    <div class="dashboard-main card">
        <!-- Навигация -->
        <nav class="dashboard-nav">
            <button class="dashboard-nav__btn active" data-target="account">Профиль</button>
            <button class="dashboard-nav__btn" data-target="cash">Наличные</button>
            <button class="dashboard-nav__btn" data-target="transfer-self">Перевод между счетами</button>
            <button class="dashboard-nav__btn" data-target="transfer-other">Перевод другому</button>
        </nav>

        <!-- Общий блок для отображения успешных операций -->
        <div th:if="${success != null}" class="alert alert-success" role="alert">
            <div class="alert__icon">✓</div>
            <div class="alert__content" th:text="${success}"></div>
            <button class="alert__close" onclick="this.parentElement.remove()">×</button>
        </div>

        <!-- Общий блок для отображения ошибок -->
        <div th:if="${error != null}" class="alert alert-danger" role="alert">
            <div class="alert__icon">⚠</div>
            <div class="alert__content" th:text="${error}"></div>
            <button class="alert__close" onclick="this.parentElement.remove()">×</button>
        </div>

        <!-- Секции -->
        <div id="account" class="dashboard-section active">

            <!-- Редактирование профиля -->
            <form class="form" th:action="@{/update-profile}" method="post">
                <div class="grid grid--2">
                    <div class="form__row">
                        <label class="label">Фамилия</label>
                        <input class="input" name="lastName" th:value="${user.lastName}" required/>
                    </div>
                    <div class="form__row">
                        <label class="label">Имя</label>
                        <input class="input" name="firstName" th:value="${user.firstName}" required/>
                    </div>
                    <div class="form__row">
                        <label class="label" for="email">Электронная почта</label>
                        <input class="input" id="email" name="email" type="email" data-validate="email" th:value="${user.email}" required/>
                        <div class="client-error" style="display: none;"></div>
                    </div>
                    <div class="form__row">
                        <label class="label" for="birthdate">Дата рождения</label>
                        <input class="input" id="birthdate" th:value="${user.birthDate}" type="date" data-validate="birthdate"/>
                        <div class="client-error" style="display: none;"></div>
                    </div>
                </div>
                <div class="row between center">
                    <button class="btn btn--ghost" type="submit">Сохранить профиль</button>
                </div>
            </form>

            <!-- Изменение пароля -->
            <form class="form" th:action="@{/change-password}" method="post" onsubmit="return validatePassword()">
                <div class="grid grid--2">
                    <div class="form__row">
                        <label class="label" for="password">Новый пароль</label>
                        <input class="input" id="password" name="password" type="password" data-validate="password" autocomplete="new-password" required/>
                        <div class="client-error" style="display: none;"></div>
                        <div class="password-strength-container">
                            <div class="password-strength">
                                <div class="password-strength__bar"></div>
                            </div>
                            <div class="password-strength__text">Введите пароль</div>
                        </div>
                    </div>
                    <div class="form__row">
                        <label class="label" for="confirmPassword">Повторите пароль</label>
                        <input class="input" id="confirmPassword" name="confirm_password" type="password" data-validate="confirm-password" autocomplete="new-password" required/>
                        <div class="client-error" id="passwordMatchError" style="display: none;">Пароли не совпадают</div>
                    </div>
                </div>
                <div class="row between center">
                    <button class="btn btn--ghost" type="submit">Изменить пароль</button>
                </div>
            </form>

            <!-- Управление счетами -->
            <form class="form" th:action="@{/add-account}" method="post">
                <div class="form__row">
                    <label class="label">Счета</label>
                    <div class="grid grid--3">
                        <div class="card" th:each="account : ${userAccounts}" th:if="${userAccounts} and ${userAccounts.size() > 0}">
                            <div class="row between center">
                                <span th:text="${account.currencyCode}"></span>
                                <span class="muted" th:text="${account.balance}"></span>
                            </div>
                            <div class="row" style="gap:8px">
                                <button class="btn btn--ghost" name="action" value="edit" th:formaction="@{/edit-account(accountId=${account.id})}">Редактировать</button>
                                <button class="btn btn--ghost" name="action" value="delete" th:formaction="@{/delete-account(accountId=${account.id})}">Удалить</button>
                            </div>
                        </div>
                        <div class="card" th:if="${userAccounts} == null or ${userAccounts.size() == 0}">
                            <span>Счета отсутствуют</span>
                        </div>
                    </div>
                </div>
                <div class="form__row">
                    <label class="label">Добавить счёт</label>
                    <select class="select" name="currencyCode">
                        <option value="" disabled selected>Выберите валюту</option>
                        <option th:each="currency : ${userNotHaveCurrencies}" th:value="${currency}" th:text="${currency}"></option>
                    </select>
                </div>
                <div class="row between center">
                    <button class="btn btn--ghost" type="submit">Добавить</button>
                </div>
            </form>

            <!-- Логин + кнопка удаления -->
            <form class="form" th:action="@{/delete-account}" method="post">
                <div class="form__row">
                    <label class="label">Логин</label>
                    <input class="input" name="username" type="text" th:value="${user.username}" readonly disabled/>
                </div>
                <div class="row between center">
                    <button class="btn btn--ghost" type="submit">Удалить аккаунт</button>
                </div>
            </form>

            <!-- Разлогиниться -->
            <div class="form__row">
                <a class="btn btn--ghost" th:href="@{/logout}">Выйти из аккаунта</a>
            </div>
        </div>

        <!-- Секция Наличные -->
        <div id="cash" class="dashboard-section">
            <h2 class="card__title">Наличные</h2>
            <form class="form" th:action="@{/cash}" method="post">
                <div class="grid grid--2">
                    <div class="form__row">
                        <label class="label">Валюта</label>
                        <select class="select" name="currency">
                            <option value="" disabled selected>Выберите валюту</option>
                            <option th:each="currency : ${userCurrencies}" th:value="${currency}" th:text="${currency}"></option>
                            <option th:if="${userCurrencies} == null or ${userCurrencies.size() == 0}" value="" disabled>Валюты недоступны</option>
                        </select>
                    </div>
                    <div class="form__row">
                        <label class="label">Сумма</label>
                        <input class="input" name="amount" type="number" step="0.01" min="0" required/>
                    </div>
                </div>
                <div class="row between center">
                    <button class="btn btn--ghost" type="submit" name="operation" value="deposit">Положить</button>
                    <button class="btn btn--ghost" type="submit" name="operation" value="withdraw">Снять</button>
                </div>
            </form>
        </div>

        <!-- Блок перевода между своими счетами -->
        <div id="transfer-self" class="dashboard-section">
            <h2 class="card__title">Перевод между своими счетами</h2>
            <form class="form" th:action="@{/transfer/own}" method="post">
                <div class="grid grid--3">
                    <div class="form__row">
                        <label class="label">Со счёта</label>
                        <select class="select" name="fromAccountId" required>
                            <option value="">Выберите счет</option>
                            <option th:each="account : ${userAccounts}" th:value="${account.id}" th:text="${account.currencyCode + ' (' + account.balance + ')'}"></option>
                        </select>
                    </div>
                    <div class="form__row">
                        <label class="label">На счёт</label>
                        <select class="select" name="toAccountId" required>
                            <option value="">Выберите счет</option>
                            <option th:each="account : ${userAccounts}" th:value="${account.id}" th:text="${account.currencyCode + ' (' + account.balance + ')'}"></option>
                        </select>
                    </div>
                    <div class="form__row">
                        <label class="label">Сумма</label>
                        <input class="input" type="number" name="amount" min="0.01" step="0.01" required/>
                    </div>
                </div>
                <div class="row between center">
                    <button class="btn btn--ghost" type="submit">Перевести</button>
                </div>
            </form>
        </div>

        <!-- Блок перевода другому пользователю -->
        <div id="transfer-other" class="dashboard-section">
            <h2 class="card__title">Перевод другому пользователю</h2>
            <form class="form" th:action="@{/transfer/other}" method="post">
                <div class="grid grid--3">
                    <div class="form__row">
                        <label class="label">Со счёта</label>
                        <select class="select" name="fromAccountId" required>
                            <option value="">Выберите счет</option>
                            <option th:each="account : ${userAccounts}" th:value="${account.id}" th:text="${account.currencyCode + ' (' + account.balance + ')'}"></option>
                        </select>
                    </div>
                    <div class="form__row">
                        <label class="label">Валюта получателя</label>
                        <select class="select" name="toCurrency" required>
                            <option value="" disabled selected>Выберите валюту</option>
                            <option th:each="currency : ${currencies}" th:value="${currency}" th:text="${currency}"></option>
                        </select>
                    </div>
                    <div class="form__row">
                        <label class="label">Получатель</label>
                        <input class="input" type="text" name="recipientEmail" placeholder="Введите email получателя" required/>
                        <div th:if="${#fields.hasErrors('recipientEmail')}" th:errors="*{recipientEmail}" class="error"></div>
                    </div>
                    <div class="form__row">
                        <label class="label">Сумма</label>
                        <input class="input" type="number" name="amount" step="0.01" min="0" required/>
                    </div>
                </div>
                <div class="row between center">
                    <button class="btn btn--ghost" type="submit">Перевести</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Курсы валют -->
    <aside class="rates-sidebar">
        <div th:replace="~{../fragments/rates :: section}"></div>
    </aside>
</section>